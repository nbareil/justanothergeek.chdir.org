<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>ld-linux.so ELF hooker - Just Another Geek</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="ld-linux.so ELF hooker" />
<meta property="og:description" content="I release a new tool, ldshatner, to inject code at runtime without the LD_PRELOAD hack" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://justanothergeek.chdir.org/2011/11/ld-linux.so-ELF-hooker/" /><meta property="article:published_time" content="2011-11-02T16:30:00&#43;00:00"/>
<meta property="article:modified_time" content="2011-11-02T16:30:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ld-linux.so ELF hooker"/>
<meta name="twitter:description" content="I release a new tool, ldshatner, to inject code at runtime without the LD_PRELOAD hack"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://justanothergeek.chdir.org/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://justanothergeek.chdir.org/css/main.css" />

	
		<script src="https://justanothergeek.chdir.org/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://justanothergeek.chdir.org/">Just Another Geek</a></h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">02</span>
							<span class="rest">Nov 2011</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">ld-linux.so ELF hooker</h1>
				</div>
			</div>
					
			<div class="markdown">
				

<div
style="-moz-border-radius: 6px; -moz-box-shadow: #F6EECD 0px 0px 200px inset; -o-box-shadow: #F6EECD 0px 0px 200px inset; -webkit-border-radius: 6px; background-color: #faf8ef; border-collapse: separate; border-radius: 6px; border-spacing: 1.428em; box-shadow: #F6EECD 0px 0px 200px inset; padding: 1.428em;">

<span
style="color: #5d2a07; letter-spacing: 0.04em; text-transform: uppercase;">**TL;DR**</span>\
[Stéphane](https://plus.google.com/108914619478390609767) and
[myself](https://plus.google.com/114289168433047035840) are releasing ag
new tool injecting code at runtime, just between the ELF loader and
target binary. It is an alternative to `LD_PRELOAD`, just a little bit
more intrusive but 100% reliable :)\
<div style="text-align: center;">

 [Sources were released on
Github](https://github.com/sduverger/ld-shatner)

</div>

<p><br />
<span style="font-family: inherit;"><br />
</span><br />
<span style="font-family: inherit;">When a binary is execve(), the
kernel extracts from the ELF headers the interpreter to be launched,
usually  </span><span
style="font-family: 'Courier New', Courier, monospace;">/lib/ld-linux.so.2</span><span
style="font-family: inherit;">. </span><span
style="background-color: transparent; font-family: inherit;">The kernel
creates a new process and prepares the environment (arguments and
auxiliary data). The target ELF entry point is set in auxiliary vector
of type &ldquo;ENTRY&rdquo;.</span><br />
<span style="background-color: transparent; font-family: inherit;"><br />
</span><br />
<span style="font-family: inherit;">Then the kernel opens the requested
interpreter, maps the memory regions and start its execution at ld&rsquo;s ELF
entry point. Then the loader analyzes the target ELF file, performs its
loader work and sets EIP to target ELF entry point (extracted from
auxv). At this point, main()&rsquo;s program is eventually executed.</span><br />
<span style="font-family: inherit;"><br />
</span><br />
<span style="font-family: inherit;">Our goal was to permit the execution
of code for abitrary dynamically linked binary without patching each of
them. So our interest moved on <span
style="background-color: transparent;">the loader, the common point
between most executables. Thus, we decided to patch a normal ld in order
to inject code. M</span></span><span
style="background-color: transparent;">y awesome colleague, </span><span
style="background-color: transparent; font-family: inherit;">Stéphane
Duverger (the <a href="https://github.com/sduverger/ramooflax">ramooflax</a>
author!) and myself wrote
</span><a href="https://github.com/sduverger/ld-shatner">ld-shatner</a>. <span
style="background-color: transparent; font-family: inherit;">Its task is
to patch </span><span
style="background-color: transparent; font-family: 'Courier New', Courier, monospace;">ld-linux.so</span><span
style="background-color: transparent; font-family: inherit;"> file
accordingly:</span><br />
<br />
<div class="separator" style="clear: both; text-align: center;"></p>

<p></div></p>

<div class="separator" style="clear: both; text-align: center;">

</div>

<div class="separator" style="clear: both; text-align: center;">

</div>

<ol>
<li><span style="background-color: transparent;"><span
style="font-family: inherit;">After ELF header, we shift &ldquo;ELF
program header&rdquo; a few pages away</span></span></li>
<li><span style="font-family: inherit;"><span
style="background-color: transparent;">In this new section, we
inject a &ldquo;loader routine&rdquo;
(<a href="https://github.com/sduverger/ld-shatner/blob/master/hooked.s">hooked.s</a>)
and</span><span style="background-color: transparent;"> embedded
code to be executed at runtime</span></span></li>
<li><span
style="background-color: transparent; font-family: inherit;">After
having been saved in our section, ld&rsquo;s ELF entry point
is </span><span
style="background-color: transparent; font-family: inherit;">overwritten
to jump directly on our routine. This routine </span><span
style="background-color: transparent; font-family: inherit;">extracts
from auxiliary vectors the target ELF entry point and </span><span
style="background-color: transparent;"><span
style="font-family: inherit;">overwrites it with a pointer to our
embedded code (</span><span
style="font-family: 'Courier New', Courier, monospace;">func()</span><span
style="font-family: inherit;"> in </span><a href="https://github.com/sduverger/ld-shatner/blob/master/obj.c">the
payload</a><span
style="font-family: inherit;">).</span></span></li>
<li><span style="background-color: transparent;"><span
style="font-family: inherit;">Original ld&rsquo;s entry point is called
and ld works as usual</span></span></li>
<li><span style="font-family: inherit;"><span
style="background-color: transparent;">Eventually, it calls entry
point set in auxiliary vector (which</span><span
style="background-color: transparent;"> was replaced by a pointer to
our payload)</span></span></li>
<li><span style="background-color: transparent;"><span
style="font-family: inherit;">Embdded code runs</span></span></li>
<li><span style="font-family: inherit;"><span
style="background-color: transparent;">It returns to our routine
which finally jumps on original target</span><span
style="background-color: transparent;"> entry point</span></span></li>
</ol>

<p><span style="background-color: transparent;">Some pictures before/after
ld-shatner voodoo:</span></p>

<hr />

<p><a href="https://docs.google.com/drawings/pub?id=134woIW7XWxLXnXc-8vNTcUyhuOqD-zt8IoQYKivDDh0&amp;w=1501&amp;h=979"><img src="https://docs.google.com/drawings/pub?id=134woIW7XWxLXnXc-8vNTcUyhuOqD-zt8IoQYKivDDh0&amp;w=1501&amp;h=979" alt="ld-shatner voodo" /></a></p>

<hr />

<h3 id="screenshot">Screenshot</h3>

<pre><code class="language-style=&quot;background-color:">$ make clean all
$ cp /lib/ld-linux.so.2 /bin/ls .
$ ./ld-shatner ld-linux.so.2 obj.elf
$ sudo cp ld-hook.so /lib/
$ ./interpatch ls
$ ./ls 
ld-hook &lt;---------------------- output of obj.elf
[...]
</code></pre>

<p><br />
(Ok, we cheat for the moment because we have to patch ls binary but we
will not have to do that eventually)</p>

<h3 id="so-what">So what?</h3>

<p>My ultimate goal for ld-shatner is to use this method for starting
applications in my sandbox
project, <a href="http://chdir.org/~nico/seccomp-nurse/">seccomp-nurse</a>. For the
moment, I rely on LD_PRELOAD feature but this approach is&hellip; hackish
and I have to work around some bugs because of this special context&hellip;</p>

			</div>

			<div class="tags">
				
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-13174242-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>
