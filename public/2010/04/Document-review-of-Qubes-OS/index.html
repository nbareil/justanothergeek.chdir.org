<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Document review of Qubes OS - Just Another Geek</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="Document review of Qubes OS" />
<meta property="og:description" content="I had a glance to Qubes OS documents, this is my review" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://justanothergeek.chdir.org/2010/04/Document-review-of-Qubes-OS/" /><meta property="article:published_time" content="2010-04-08T15:03:00&#43;00:00"/>
<meta property="article:modified_time" content="2010-04-08T15:03:00&#43;00:00"/>
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Document review of Qubes OS"/>
<meta name="twitter:description" content="I had a glance to Qubes OS documents, this is my review"/>
<link href='https://fonts.googleapis.com/css?family=Playfair+Display:700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" type="text/css" media="screen" href="https://justanothergeek.chdir.org/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="https://justanothergeek.chdir.org/css/main.css" />

	
		<script src="https://justanothergeek.chdir.org/js/main.js"></script>
</head>

<body>
	<div class="container wrapper">
		<div class="header">
	
	<h1 class="site-title"><a href="https://justanothergeek.chdir.org/">Just Another Geek</a></h1>
	<div class="site-description"><nav class="nav social">
			<ul class="flat"></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
		</ul>
	</nav>
</div>


		<div class="post">
			<div class="post-header">
				
					<div class="meta">
						<div class="date">
							<span class="day">08</span>
							<span class="rest">Apr 2010</span>
						</div>
					</div>
				
				<div class="matter">
					<h1 class="title">Document review of Qubes OS</h1>
				</div>
			</div>
					
			<div class="markdown">
				

<h2 id="qubes-os">Qubes OS</h2>

<p><a href="http://theinvisiblethings.blogspot.com/2010/04/introducing-qubes-os.html">You</a>
<a href="http://tech.slashdot.org/story/10/04/07/1754208/Researcher-Releases-Hardened-OS-Qubes-Xen-Hits-40?">must
have</a>
<a href="http://linuxfr.org/2010/04/07/26705.html">heard</a>
<a href="http://twitter.com/alexsotirov/statuses/11796459373">about</a> it,
<a href="http://invisiblethingslab.com/">Invisible Things Lab</a> released their
own operating system, named <a href="http://www.qubes-os.org/">Qubes OS</a> (If you
ask me, I would have refer to it as a Linux distribution instead). Their
distribution focuses on security isolation and is based on their
virtualization experience (for the record, Joanna and Rafal are the
people behind most of the virtualization vulnerabilities found in the
previous years).</p>

<blockquote>
<p><strong>Disclaimer</strong>: I do not had the occasion to test the system, this
post is only based on my reading of their (great) <a href="http://www.qubes-os.org/files/doc/arch-spec-0.3.pdf">QubesOs
architecture
paper</a> (version
0.3). I did not read the source code or whatever so be careful with
what is following :)</p>
</blockquote>

<h3 id="target-of-the-distribution">Target of the distribution</h3>

<p>Maybe I am guessing wrong, but this distribution seems to be really
dedicated for classified environments. Even if it is usable by anyone,
some concepts make me believe this work will be sold to government or
military people because it full-fills most of the requirements. Anyway,
this is awesome to release it to the public, in an Open Source licence.</p>

<p>I am sure that this release will be really helpful for the people
involved in &ldquo;<a href="http://www.ssi.gouv.fr/site_article91.html">SEC&amp;SI
challenge</a>&rdquo; organized by the
french government. This research project is dedicated to the
construction of a secure Desktop platform (Linux based) usable by my
grandma.</p>

<h3 id="what-is-new">What is new?</h3>

<p>There is nothing new by itself: only components already available in the
community have been used (Linux kernel, Xen, Xorg, LUKS, device mapper,
etc.), few code have been developed.</p>

<p>The beauty of their solution is that every techniques used are
individually known but nobody had the idea to put them together like
they did. Bravo!</p>

<h3 id="the-big-picture">The big picture</h3>

<p>User activities can be identified in multiple security levels: web
browsing, banking, corporate work, social networking, e-shopping, etc.</p>

<p>Each activity represents a security domain: banking activities are more
critical than social networking (right?). Usually, on most of operating
systems, every activities are in the same &ldquo;space&rdquo;: if you are
compromised while browsing <a href="#sec-1.3">youtube.com</a>, the attacker can
access to your sensitive data (bank account or corporate email).</p>

<p>So QubesOS resolves this problem by running each domain into a virtual
machine (called <em>AppVM</em> in QubesOS terminology), the virtualization
solution they chose is Xen. They explain why they chose Xen instead of
KVM in their architecture guide.</p>

<p>Thanks to the Xen hypervisor, each AppVM is isolated and cannot have
access to other ressources than its own.</p>

<h3 id="architecture">Architecture</h3>

<h4 id="multimedia">Multimedia</h4>

<ul>
<li><p>Display</p>

<p>Until Qubes OS, every Linux distribution providing &ldquo;multi level
security&rdquo; use one X server running on the Host (in Dom0) and each
virtual machine uses the display thanks to:</p>

<ul>
<li>VNC-over-ssh. Problem: VNC client and server have not really
been audited and they are crippled of security issues.</li>
<li>X11 forwarding. Problem: There is basically no security control
in X11, a X client can do anything on other windows like
capturing or injecting keystrokes, snooping other
applications, etc. This is problematic when windows do not have
the same security level.</li>
</ul>

<p>A lesser used alternative is the use of one Xorg server per virtual
machine: each security level is inside a virtual terminal. However,
unless there is a video card per X session, every servers share the
same hardware resource so a vulnerability in Xorg would impact other
Xorg servers.</p>

<p>The innovation of Qubes OS is to not use any of theses methods. Each
AppVM runs a Xorg instance (with a &ldquo;dummy graphic driver&rdquo;, which I
guess is not tied to any hardware device) and a <em>AppVM Window
Manager</em>.</p>

<p>The dom0 domain runs the &ldquo;real&rdquo; Xorg server tied to the graphic card
and multiple <em>AppViewers</em>, each <em>AppViewer</em> communicates with one
<em>AppVM Window Manager</em> (which is inside a <em>AppVM</em>) via the Xen Ring
buffer protocol. The task of each <em>AppViewer</em> is to proxify input
devices to the right <em>AppVM</em> (depending on who has the focus). Each
virtual machine uses a homemade input xorg-driver called
<code>xf86-input-mfndev</code> (which gets its input from the ring buffer).</p>

<p>Each <em>AppVM Window Manager</em> sends notifications to its associated
<em>AppViewer</em>. The events monitored are: creation of new window,
content refresh or change of window focus.</p>

<p>When an <em>AppViewer</em> receives a <em>content refresh</em> notification, it
requests to the <em>AppVM Window Manager</em> its <em>composition buffer</em> (the
bitmap of the window content in other words). It receives theses
bytes from the ring buffer and displays it on the screen.</p>

<p>The optimization, which is still being investigate, is to ask the
address of the composition buffer instead of the sending the
raw bitmap. This is possible because the dom0 has access to the
address space of every <em>AppVM</em> so it can directly use the bytes to
render it without involving a double-copy.</p>

<p>However, I do not know if this optimization would be sufficient to
handle video playback: the paper suggests that the user can watch
video on youtube so it seems to work, but I don&rsquo;t see how. Even on
my &ldquo;normal&rdquo; desktop, the system goes slow if I simply disable
Xvideo overlay.</p></li>

<li><p>Audio</p>

<p>Audio support is not yet implemented but will be certainly based on
the same principle than the &ldquo;composition buffer&rdquo;: audio stream will
be &ldquo;written&rdquo; in a buffer readable by <em>AppViewer</em>.</p>

<p>That way, a dom0 daemon just has to mix every <em>AppViewer</em> audio
streams and eventually sends the final stream to the sound card.</p></li>

<li><p>Clipboard</p>

<p>&ldquo;Applicative clipboard&rdquo; (in opposition to X11 clipboard mechanism)
operations are supported between <em>AppVM</em>. The user has to press a
special shortcut (S-C-v) which is intercepted by the dom0 and not
passed to <em>AppVM</em>. At this point, the <em>AppViewer</em> triggers a command
on the virtual machine, sending the content of the cursor selection
through the Xen ring buffer. The bytes are then stored in a volatile
file on dom0.</p>

<p>When the special <em>paste shortcut</em> is pressed, the dom0 injects the
stored result via the ring buffer again and emulates the
paste action.</p></li>
</ul>

<h4 id="storage-architecture">Storage architecture</h4>

<p><em>AppsVMs</em> share the same &ldquo;base filesystem&rdquo; in order to not waste disk
space. For that matter, each domain mounts a read-only block device and
mounts, on top of it, a copy-on-write block device (thanks to the
kernel&rsquo;s device-mapper) accessible only to the <em>AppVM</em>.</p>

<p>Each time an <em>AppVM</em> is started, the copy-on-write volume is deleted in
order to have a clean environment. Persistent data (like user documents)
are stored in another private volume which is restored at <em>AppVM</em>
creation time.</p>

<p>Every block devices are exported by the <em>Storage Domain</em>. This
abstraction layer is needed to make possible file-sharing between
<em>AppVMs</em> (thanks to a homemade cryptographic protocol).</p>

<p>We can see that the <em>Storage Domain</em> has great powers. To counterbalance
it, cryptography was used.</p>

<p>The &ldquo;base read-only block device&rdquo; is signed (on a per-block basis). The
private key is available only to the TPM and the dom0.</p>

<p>Application specific volumes (the copy-on-write overlay and the
persistent block device) are encrypted (with LUKS) with a key available
only to <em>AppVMs</em> and the dom0.</p>

<p>Thanks to this design, a compromission of the <em>Storage Domain</em> would be
worthless because any attempt to modify data would be detected and
persistent files are encrypted so an attacker would be disappointed :)</p>

<h4 id="network-architecture">Network architecture</h4>

<p>Most of the remote vulnerabilities found in the Linux kernel have been
discovered in device drivers like network adapters. Because any bug
found in the kernel puts in danger the whole system, it would be great
to find a way to isolate theses drivers.</p>

<p>Thanks to recent CPU features, it is now possible to do such thing:
Intel VT-d technology permits to safely give to a virtual machine access
to a hardware device.</p>

<p>In other words, QubesOS now delegates the PCI wireless card to an
<em>AppVM</em>, called <em>Network domain</em>. At this point, if a vulnerability is
found in the wifi driver, only the virtual machine is compromised.</p>

<p>The <em>Network domain</em> is the border router: every <em>AppVM</em> routes its
traffic through it. One of its task is also to enforce traffic policy:
<em>AppVMs</em> are not allowed to communicate between each other, only HTTPS
flows are allowed for the banking domain, only VPN traffic is allowed
for corporate domain, etc.</p>

<h3 id="conclusion">Conclusion</h3>

<p>On the paper, Qubes OS seems really well designed and robust from a
security point of view. By glancing at the screenshots, the user
experience seems good. I don&rsquo;t know how good/bad are the performances:
memory usage must be really high (because AFAIK, Xen does not implement
the &ldquo;<a href="http://thread.gmane.org/gmane.comp.emulators.kvm.devel/31003">Kernel Samepage
Merging</a>&ldquo;
feature available in KVM since 2.6.32).</p>

<p>But, anyway, congratulations to &ldquo;Invisible Things Lab&rdquo; for this great
architecture!</p>

			</div>

			<div class="tags">
				
					
				
			</div></div>
	</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> <a href="https://github.com/knadh/hugo-ink">Ink</a> theme on <a href="https://gohugo.io">Hugo</a></div>
	</nav>
</div>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-13174242-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

</body>
</html>
